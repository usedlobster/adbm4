class wdTable{fixArraySequence(arr,n){Array.isArray(arr)||(arr=[]);var seen=new Set,repaired=[];for(let i=0;i<arr.length;i++){var idx=arr[i];Number.isInteger(idx)&&0<=idx&&idx<n&&!seen.has(idx)&&(repaired.push(idx),seen.add(idx))}for(let i=0;i<n;i++)seen.has(i)||repaired.push(i);return repaired}recalculateModalIndices(d,k,v){let up=-1,down=-1;if(this.col[d.data.defs[k].pos]?.moveable??!0){for(let j=k-1;0<=j;j--)if(this.col[d.data.defs[j].pos]?.moveable){up=j;break}for(let j=k+1;j<d.data.defs.length;j++)if(this.col[d.data.defs[j].pos]?.moveable){down=j;break}}if(d.data.defs[k].up=up,d.data.defs[k].down=down,up=-1,down=-1,this.col[d.data.defs[v].pos]?.moveable??!0){for(let j=v-1;0<=j;j--)if(this.col[d.data.defs[j].pos]?.moveable){up=j;break}for(let j=v+1;j<d.data.defs.length;j++)if(this.col[d.data.defs[j].pos]?.moveable){down=j;break}}d.data.defs[v].up=up,d.data.defs[v].down=down}setupTABLE(){this.usercfg=JSON.parse(localStorage.getItem(this.T0.id+"_cfg")??"{}"),(this.cfg?.version??0)!==(this.usercfg?.version??0)&&(this.usercfg=null);let pos=0;var layout;this.col=[],this.cfg.columns?.forEach(col=>{col?.field&&(this.col.push({pos:pos,field:col?.field,title:col?.title??col?.field??pos+1,sortable:col?.sortable??!0,moveable:col?.moveable??!0,exportable:col?.exportable??!0,sort:col?.sort??0,width:col?.width??1,type:col?.type??"text"}),pos++)}),this.ncols=this.col.length,this.colorder=this.fixArraySequence(this.cfg?.order,this.ncols),this?.usercfg&&(layout=this.usercfg?.layout)&&(Array.isArray(layout?.order)&&(this.colorder=this.fixArraySequence(layout.order,this.ncols)),Array.isArray(layout?.defs))&&layout.defs.length===this.ncols&&layout.defs.forEach((def,i)=>{var col=this.col[def.pos];col.title=def?.name,col.width=def?.width,col.visible=def?.vis,col.exportable=def?.exp,col.sort=def?.sort??0,this.col[def.pos]=col}),this.ref.tableHeader=!0,this.ref.tableColGroup=!0,this.fetchPage()}setupINNER(){if(this.T1=document.createElement("div"),!this.T1)throw new Error("wdTable: cannot create table");this.T1.id=this.T0.id+"_table",this.T1.className="wd-table-box",this.T0.appendChild(this.T1)}setupMODAL(){if(this.MODAL=document.createElement("div"),!this.MODAL)throw new Error("wdTable: cannot create modal");this.MODAL.id=this.T0.id+"_modal",this.MODAL.className="wd-modal overflow-hidden",this.MODAL.style.display="none",this.T0.appendChild(this.MODAL)}repaginate(){let newPage=Math.floor(this.data.offset/this.view.pageLength);var newCount=Math.ceil(this.data.total/this.view.pageLength);(newPage=(newPage=newPage<0?0:newPage)>newCount-1?0<newCount?newCount-1:0:newPage)===this.view.page&&newCount===this.view.npages||(this.view.npages=newCount,this.view.page=newPage,this.ref.footBlock=!0)}setData(data,total,offset){(offset<0||0==total)&&(offset=0),this.data.data=data??[],this.data.offset=offset??0,this.data.total=total??0,this.repaginate(),this.ref.tableBody=!0,this.ref.tableHeader=!0,this.ref.tableFooter=!0,this.updateView()}showLoading(a=null){this.ref.loading=null!==a?a:this.ref.loading,this.T1.style.opacity=this.ref.loading?"0.6":"1.0"}fetchNewData(){if(this?.cfg?.ajax)try{this.showLoading(!0);let defs=[];this.col?.forEach(col=>{col?.field&&defs.push({field:col.field,sort:col?.sortable?col.sort:0,vis:col?.visible??!0,searchable:col?.searchable??!0})});var payload={refresh:++this.ref.refresh,defs:defs,offset:this.view.page*this.view.pageLength,limit:this.view.pageLength,search:this.view.search??""};console.log("fetchNewData: payload = ",payload),_wd_api_fetch(this.cfg.ajax?.url,payload,res=>{res&&res?.refresh===this.ref.refresh&&(this.setData(res?.data,res?.total,res?.offset),this.ref.loading=!1),this.showLoading(!1)})}catch(e){this.showLoading(!1),console.log(e),alert(e)}}fetchPage=_wd_debounce(()=>{this.fetchNewData()},200);makeBlock=(base,name,tag,cb)=>_wd_make_block(base,name,tag,cb);constructor(divid,jobj){if(!divid||!jobj||"string"!=typeof divid||"object"!=typeof jobj)throw new Error("Invalid arguments");this.T0=document.getElementById(divid);try{if(!this.T0||"DIV"!==this.T0?.tagName)throw new Error("Invalid Divid");this.T0.innerHTML="",this.view={page:0,pageLength:10,search:""},this.ref={refresh:0,all:!0,highlight:!0},this.data={data:[],offset:0,total:0},this.cfg=jobj?.table,this.setupTABLE(),this.setupMODAL(),this.setupINNER()}catch(e){console.log(e),alert(e)}this.highlighter="undefined"!=typeof wdTextHighlighter?new wdTextHighlighter({className:"highlight"}):null}tableAlpineData(){if(!Alpine)throw new Error("wdTable: alpine not found");var d=Alpine.$data(this.MODAL.firstChild);if(!d)throw new Error("wdTable: cannot get alpine data");d.data={},d.data.title=this.cfg?.title??"",d.data.defs=[];for(let k=0;k<this.colorder.length;k++){var ord=this.colorder[k],ord=this.col[ord];let up=-1,down=-1;if(ord?.moveable??!0){for(let j=k-1;0<=j;j--)if(this.col[this.colorder[j]]?.moveable){up=j;break}for(let j=k+1;j<this.colorder.length;j++)if(this.col[this.colorder[j]]?.moveable){down=j;break}}d.data.defs.push({pos:ord.pos,up:up,down:down,field:ord.field,renameable:ord?.renameable??!1,moveable:ord?.moveable??!0,sortable:ord?.sortable??!0,sort:ord?.sortable??!0?ord?.sort:void 0,name:ord.title,width:ord?.width??1,vis:ord?.visible??!0,exp:ord?.exportable??!0})}return d}tableModalAction(act,k,v){var moveModalRow=(k,v,dir)=>{if(0<=v&&k!==v){let d=Alpine.$data(this.MODAL.firstChild);d.data.defs[k]._animate="out-"+dir,d.data.defs[v]._animate="in-"+dir,setTimeout(()=>{var tmp=d.data.defs[k];d.data.defs[k]=d.data.defs[v],d.data.defs[v]=tmp,this.recalculateModalIndices(d,k,v),setTimeout(()=>{d.data.defs[k]._animate=null,d.data.defs[v]._animate=null},50)},450)}},modalSortChange=k=>{var d=Alpine.$data(this.MODAL.firstChild);if(d&&d.data&&d.data.defs)for(let i=0;i<this.ncols;i++){var usr=d.data.defs[i];usr?.sortable&&(i===k?usr.sort=usr.sort<0?1:-1:0!==usr.sort&&(usr.sort=0))}},saveModal=()=>{var d=Alpine.$data(this.MODAL.firstChild);if(d&&d.data&&d.data.defs){var newOrder=[],newDefs=[];for(let k=0;k<d.data.defs.length;k++){var usr=d.data.defs[k];newOrder.push(usr.pos),newDefs.push({pos:usr?.pos,name:usr?.name,width:+(usr?.width??1),vis:usr?.vis??!0,exp:usr?.exp??!0,sort:usr?.sort??void 0})}this.usercfg||(this.usercfg={}),this.usercfg.version=this.cfg?.version??0,this.usercfg.layout={order:newOrder,defs:newDefs},localStorage.setItem(this.T0.id+"_cfg",JSON.stringify(this.usercfg)),this.setupTABLE()}},resetModal=()=>{localStorage.removeItem(this.T0.id+"_cfg"),this.usercfg={},this.setupTABLE(),this.tableAlpineData(Alpine.$data(this.MODAL.firstChild))};switch(act){case"modal_init":k.setAttribute("x-data","{ data: {} , init() { return this.$root.modalFn( 'init' ) } , action( t , k , v ) { this.$root.modalFn(t,k,v)} }");break;case"init":return this.tableAlpineData();case"reset":resetModal();break;case"close":_wd_close_modal_template(this.MODAL);break;case"save":saveModal(),_wd_close_modal_template(this.MODAL);break;case"up":moveModalRow(k,v?.up,"up");break;case"down":moveModalRow(k,v?.down,"down");break;case"sort":modalSortChange(k)}}updateCaption(){this.makeBlock(this.T1,"cap","div",(E,einit)=>{einit&&(E.className="wd-table-section wd-cap-block"),E.textContent=this.cfg?.title??"Table"}),this.ref.capBlock=!1}updateHeaderBlock(){this.makeBlock(this.T1,"head","div",(E,einit)=>{einit&&(E.className="wd-table-section wd-head-block"),this.ref.headPageLen&&(this.makeBlock(E,"pagelen","select",(Q,qinit)=>{qinit&&(Q.className="wd-page-len",[1,3,5,10,15,20,25,50,100,200,500].forEach(v=>{var O=document.createElement("option");O.value=+v,O.textContent=v,Q.appendChild(O)}),Q.addEventListener("change",()=>{this.view.pageLength=Q.value,this.view.page=0,this.fetchPage()})),Q.value=this.view.pageLength}),this.ref.headPageLen=!1),(einit||this.ref.headSearchBar)&&(this.makeBlock(E,"search","input",(Q,qinit)=>{qinit&&(Q.className="wd-search-box",Q.setAttribute("type","text"),Q.setAttribute("placeholder","Search"),Q.setAttribute("spellcheck","off"),Q.plceholder="Search",Q.addEventListener("input",()=>{this.view.search=Q.value,this.fetchPage()})),Q.value=this.view.search}),this.ref.headSearchBar=!1),(einit||this.ref.headControl)&&(this.makeBlock(E,"open-modal","button",(Q,qinit)=>{qinit&&(Q.className="wd-open-modal-btn button-hover",Q.textContent="Options",Q.addEventListener("click",()=>{_wd_open_modal_template(this.MODAL,"table_modal",(act,k,v)=>this.tableModalAction(act,k,v))}))}),this.ref.headControl=!1)}),this.ref.headBlock=!1}updateQbarBlock(){let qbar=this?.cfg?.qbar;qbar&&this.makeBlock(this.T1,"qbar","div",(E,einit)=>{einit&&(E.className="wd-table-section wd-qbar-block",E.innerHTML='<div class="wd-qbar-inner"></div>');let Q=E?.firstElementChild;Q&&(Q?.id||(Q.id=E.id+"_q"),qbar.forEach((q,i)=>{this.makeBlock(Q,i,"div",(B,binit)=>{binit&&(B.className="wd-qbar-item","btn"===q?.type?(B.innerHTML='<button class="wd-qbtn">'+q.name+"</button>",B.addEventListener("click",()=>{})):Q.removeChild(B))})}))}),this.ref.qbarBlock=!1}updateTableView(){let setTH=(TH,i)=>{i=this.col[this.colorder[i]],TH=TH?.firstChild;TH&&(TH.children[0].textContent="",TH.children[1].textContent=i.title,TH.children[2].className="ml-1 py-2 mr-1",i?.sortable??!0?TH.children[2].textContent=0<i?.sort?"▲":i?.sort<0?"▼":"⬩":TH.children[2].textContent="")},setTD=(TD,cdef,v)=>{var t=cdef?.type??"text";if(TD&&(this.ref.highlight||TD._cachedValue!==v||TD._cacheType!==t)){switch(t){case"text":(cdef?.searchable??!0)&&""!==v&&this.highlighter&&this.view.search?TD.innerHTML=this.highlighter.highlight(v,this.view.search):TD.textContent=v;break;case"button":TD.innerHTML='<button class="wd-btn">Edit</button>';break;default:TD.textContent="["+v+"]"}TD._cacheType=t,TD._cachedValue=v}},toggleSort=colidx=>{for(let i=0;i<this.ncols;i++){var idx=this.colorder[i];i===colidx?this.col[idx].sort=this.col[idx].sort<0?1:-1:this.col[idx].sort=0}this.fetchPage()};this.makeBlock(this.T1,"table","table",(E,einit)=>{if(einit&&(E.className="wd-table-section wd-table-block",E.appendChild(document.createElement("colgroup")),E.appendChild(document.createElement("thead")),E.appendChild(document.createElement("tbody")),E.appendChild(document.createElement("tfoot"))),einit||this.ref.tableColGroup){var Q=E?.children?.[0];Q.childElementCount!==this.ncols&&(Q.innerHTML="");let sum=0;this.colorder.forEach(i=>sum+=this.col[i]?.visible??!0?this.col[i].width:0);for(let i=0;i<this.ncols;i++){let COL=Q.children[i];COL||(COL=document.createElement("col"),Q.appendChild(COL));var cdef=this.col[this.colorder[i]],w=Math.floor(cdef?.visible??!0?cdef.width:0);cdef?.visible??!0?(COL.style.width=0<sum?Math.floor(1e3*w/sum)/10+"%":"0",COL.style.visibility="visible"):(COL.style.width="0px",COL.style.visibility="collapse")}this.ref.tableColGroup=!1}if(einit||this.ref.tableHeader){let Q=E?.children?.[1],TR=Q?.firstChild;TR||(TR=document.createElement("tr"),Q.appendChild(TR)),TR.childElementCount!==this.ncols&&(TR.innerHTML="");for(let i=0;i<this.ncols;i++){let TH=TR.children[i];var D;TH||((TH=document.createElement("th")).className="wd-th",(D=document.createElement("div")).setAttribute("role","button"),D.setAttribute("tabindex","0"),D.className="wd-th-inner",D.appendChild(document.createElement("div")),D.appendChild(document.createElement("div")),D.appendChild(document.createElement("div")),TH.appendChild(D),TH.addEventListener("click",()=>{toggleSort(i)}),TR.appendChild(TH)),setTH(TH,i)}this.ref.tableHeader=!1}if(einit||this.ref.tableBody){let Q=E?.children?.[2];var nrows=Math.min(this.view.pageLength,this?.data?.data?.length??0);if(0<nrows){nrows!==Q?.childElementCount&&(Q.innerHTML='<tr class="wd-tr"></tr>'.repeat(nrows));let col_html="";Q.firstElementChild?.childElementCount!==this.ncols&&(col_html='<td class="wd-td"></td>'.repeat(this.ncols));for(let j=0;j<nrows;j++){var TR=Q?.children[j],datarow=(col_html&&(TR.innerHTML=col_html),this?.data?.data[j]);if(datarow)for(let i=0;i<this.ncols;i++){var TD=TR?.children[i],ord=this.colorder[i];let cdef=this.col[ord];setTD(TD,cdef,datarow[ord])}}}else Q.innerHTML=`
                          <tr>
                            <td colspan=${this.ncols}>NO DATA</td>
                          </tr>`;this.ref.tableBody=!1,this.ref.highlight=!1}if(einit||this.ref.tableFooter){let Q=E?.children?.[3],TR=Q?.firstChild;TR||(TR=document.createElement("tr"),Q.appendChild(TR)),TR.childElementCount!==this.ncols&&(TR.innerHTML="");for(let i=0;i<this.ncols;i++){let TD=TR.children[i];TD||((TD=document.createElement("th")).className="wd-tf",TR.appendChild(TD)),TD.textContent=""}this.ref.tableFooter=!1}}),this.ref.tableBlock=!1}updateFooterBlock(){this.makeBlock(this.T1,"foot","div",(E,einit)=>{var S1,Q1;einit&&(E.className="wd-table-section wd-footer-block",E.innerHTML=`
                  <div class="wd-foot-page-info-div">
                    <input type="number" min="1" class="page-input"/>
                    <span></span>
                  </div>
                  <div class="wd-foot-page-list-div">
                  </div>`,(E?.children[0]?.children[0]).addEventListener("change",_wd_debounce(e=>{e=Math.max(1,parseInt(e.target.value)||1);this.view.page=e-1,this.fetchPage()},200))),(einit||this.ref.footPageInfo)&&((Q1=E?.children?.[0])&&(S1=Q1?.children[0],Q1=Q1?.children[1],S1.value=this.view.page+1,S1.setAttribute("max",this.view.npages),Q1.textContent=" of "+this.view.npages),this.ref.footPageInfo=!1),(einit||this.ref.footPageList)&&(this.ref.footPageList=!1),E.style.display=0<this.view.npages?"block":"none"}),this.ref.footBlock=!1}updateView(){this.ref.all&&(this.ref.capBlock=!0,this.ref.headBlock=!0,this.ref.qbarBlock=!0,this.ref.tableBlock=!0,this.ref.footBlock=!0),this.ref.capBlock&&this.updateCaption(),this.ref.headBlock&&(this.ref.headPageLen=!0,this.ref.headSearchBar=!0,this.ref.headControl=!0),(this.ref.headBlock||this.ref.headPageLen||this.ref.headSearchBar||this.ref.headControl)&&this.updateHeaderBlock(),this.ref.qbarBlock&&this.updateQbarBlock(),this.ref.tableBlock&&(this.ref.tableColGroup=!0,this.ref.tableHeader=!0,this.ref.tableBody=!0,this.ref.tableFooter=!0),(this.ref.tableBlock||this.ref.tableColGroup||this.ref.tableHeader||this.ref.tableBody||this.ref.tableFooter)&&this.updateTableView(),this.ref.footBlock&&(this.ref.footPageInfo=!0,this.ref.footPageList=!0),(this.ref.footPageInfo||this.ref.footPageList)&&this.updateFooterBlock(),this.ref.all=!1}}